<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Novyn — Where Moments Connect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="bg-shape bg-shape-one" aria-hidden="true"></div>
    <div class="bg-shape bg-shape-two" aria-hidden="true"></div>
    <div class="grain-layer" aria-hidden="true"></div>

    <main class="app-shell">

      <!-- ─── Top bar ──────────────────────────────── -->
      <header class="app-topbar">
        <div class="brand">
          <svg class="brand-logo" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Novyn logo" role="img">
            <defs>
              <linearGradient id="lg1" x1="0" y1="0" x2="42" y2="42" gradientUnits="userSpaceOnUse">
                <stop offset="0%" stop-color="#00e5ff"/>
                <stop offset="100%" stop-color="#7c3aed"/>
              </linearGradient>
            </defs>
            <rect width="42" height="42" rx="13" fill="url(#lg1)"/>
            <rect x="4" y="4" width="34" height="34" rx="9" fill="rgba(5,8,15,0.52)"/>
            <circle class="brand-logo-ring" cx="21" cy="21" r="6"  fill="none" stroke="#00e5ff" stroke-width="2"/>
            <circle class="brand-logo-ring" cx="21" cy="21" r="10" fill="none" stroke="#00e5ff" stroke-width="1.5" opacity="0.7"/>
            <circle class="brand-logo-ring" cx="21" cy="21" r="14" fill="none" stroke="#00e5ff" stroke-width="1"   opacity="0.4"/>
            <circle cx="21" cy="21" r="3" fill="#00e5ff"/>
            <circle cx="15" cy="13" r="2.5" fill="rgba(255,255,255,0.28)"/>
          </svg>
          <div>
            <p class="eyebrow">Where Moments Connect</p>
            <h1>Novyn</h1>
          </div>
        </div>

        <div class="topbar-right">
          <div id="networkPill" class="network-pill" role="status" aria-live="polite">
            <span class="signal-dot" aria-hidden="true"></span>
            <span id="connectionLabel">Connecting…</span>
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark/light mode" title="Toggle theme">
            <span class="theme-toggle-thumb">
              <svg class="icon-moon" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M10.5 7.5A5 5 0 0 1 4.5 1.5a5 5 0 1 0 6 6z" fill="#c8d7ff" stroke="#c8d7ff" stroke-width="0.5" stroke-linejoin="round"/>
              </svg>
              <svg class="icon-sun" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="6" cy="6" r="2.5" fill="#f9a825"/>
                <g stroke="#f9a825" stroke-width="1" stroke-linecap="round">
                  <line x1="6" y1="0.5" x2="6" y2="2"/><line x1="6" y1="10" x2="6" y2="11.5"/>
                  <line x1="0.5" y1="6" x2="2" y2="6"/><line x1="10" y1="6" x2="11.5" y2="6"/>
                  <line x1="2.05" y1="2.05" x2="3.1" y2="3.1"/><line x1="8.9" y1="8.9" x2="9.95" y2="9.95"/>
                  <line x1="9.95" y1="2.05" x2="8.9" y2="3.1"/><line x1="3.1" y1="8.9" x2="2.05" y2="9.95"/>
                </g>
              </svg>
            </span>
          </button>
        </div>
      </header>

      <!-- ─── Login card ───────────────────────────── -->
      <section id="loginCard" class="card login-card" aria-label="Login">

        <!-- Hero panel — redesigned as a chat preview mockup -->
        <div class="login-hero">
          <p class="eyebrow">Where Moments Connect</p>
          <h2>Where every moment finds its place.</h2>
          <p>Add friends, share moments, and stay connected — beautifully, privately, instantly.</p>

          <!-- Chat bubble mockup visual -->
          <div class="hero-visual" aria-hidden="true">
            <div class="hero-mock">
              <!-- Mock chat header -->
              <div class="mock-header">
                <div class="mock-avatar" style="background:linear-gradient(135deg,#00e5ff,#7c3aed)">A</div>
                <div>
                  <div class="mock-name">Aarav</div>
                  <div class="mock-status">
                    <span class="mock-dot"></span>Online
                  </div>
                </div>
              </div>
              <!-- Mock messages -->
              <div class="mock-messages">
                <div class="mock-msg mock-them">
                  <div class="mock-bubble">Hey! Did you see the sunset? 🌅</div>
                  <div class="mock-time">6:41 PM</div>
                </div>
                <div class="mock-msg mock-me">
                  <div class="mock-bubble">It was gorgeous 😍 Sent you some pics!</div>
                  <div class="mock-time">6:42 PM · Delivered</div>
                </div>
                <div class="mock-msg mock-them">
                  <div class="mock-bubble">
                    <span class="mock-reaction-row">❤️ 2</span>
                    Love them! Let's go again tomorrow 🔥
                  </div>
                  <div class="mock-time">6:43 PM</div>
                </div>
                <!-- Typing indicator -->
                <div class="mock-typing">
                  <div class="mock-avatar-sm" style="background:linear-gradient(135deg,#00e5ff,#7c3aed)">A</div>
                  <div class="mock-dots">
                    <span></span><span></span><span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <ul class="feature-list">
            <li>Instant updates via WebSockets</li>
            <li>Emoji reactions on every message</li>
            <li>Dark &amp; light themes built in</li>
          </ul>
        </div>

        <!-- Login form panel -->
        <div class="login-panel">
          <div class="login-panel-logo" aria-hidden="true">
            <svg viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg" width="48" height="48">
              <defs>
                <linearGradient id="lg2" x1="0" y1="0" x2="42" y2="42" gradientUnits="userSpaceOnUse">
                  <stop offset="0%" stop-color="#00e5ff"/>
                  <stop offset="100%" stop-color="#7c3aed"/>
                </linearGradient>
              </defs>
              <rect width="42" height="42" rx="13" fill="url(#lg2)"/>
              <rect x="4" y="4" width="34" height="34" rx="9" fill="rgba(5,8,15,0.52)"/>
              <circle cx="21" cy="21" r="6"  fill="none" stroke="#00e5ff" stroke-width="2"/>
              <circle cx="21" cy="21" r="10" fill="none" stroke="#00e5ff" stroke-width="1.5" opacity="0.7"/>
              <circle cx="21" cy="21" r="3" fill="#00e5ff"/>
            </svg>
          </div>
          <h3>Join Novyn</h3>
          <p>New username creates an account. Existing username requires your password.</p>
          <form id="loginForm" novalidate>
            <input id="usernameInput" type="text"     maxlength="24"        placeholder="Username"  autocomplete="username"          required/>
            <input id="passwordInput" type="password" minlength="4" maxlength="72" placeholder="Password" autocomplete="current-password" required/>
            <button type="submit">Enter Novyn →</button>
          </form>
          <p class="login-footnote">🔒 Encrypted password storage &amp; secure session handling.</p>
          <p   id="usernameHint"        class="username-hint hidden"></p>
          <div id="usernameSuggestions" class="username-suggestions hidden"></div>
        </div>
      </section>

      <!-- ─── Chat layout ──────────────────────────── -->
      <section id="chatLayout" class="chat-layout hidden" aria-label="Chat">

        <!-- Sidebar -->
        <aside class="sidebar card" id="mobileSidebar" aria-label="Friends &amp; requests">

          <div class="me-row">
            <div class="me-row-info">
              <div class="me-avatar" id="meAvatar" aria-hidden="true">?</div>
              <div class="me-row-text">
                <p class="eyebrow">Signed in as</p>
                <h2 id="meName">@you</h2>
              </div>
            </div>
            <!-- Logout button -->
            <button class="logout-btn" id="logoutBtn" title="Log out" aria-label="Log out">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
            </button>
          </div>

          <form id="addFriendForm" class="add-friend-form">
            <input id="friendInput" type="text" maxlength="24" placeholder="Add friend by username" autocomplete="off" required/>
            <button type="submit">Add</button>
          </form>

          <div class="list-panel" aria-label="Friend requests">
            <div class="list-head">
              <h3>Requests</h3>
              <span id="requestCount" class="count-pill">0</span>
            </div>
            <ul id="requestList" aria-live="polite"></ul>
          </div>

          <div class="list-panel friends-panel" aria-label="Friends">
            <div class="list-head">
              <h3>Friends</h3>
              <span id="friendCount" class="count-pill">0</span>
            </div>
            <ul id="friendList" aria-live="polite"></ul>
          </div>
        </aside>

        <!-- Chat area -->
        <section class="chat card" id="mobileChat" aria-label="Conversation">

          <header class="chat-header">
            <button class="mob-back-btn" id="mobBackBtn" aria-label="Back to friends">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <div class="chat-header-info">
              <p class="eyebrow">Conversation</p>
              <h2 id="activeFriendLabel">Select a friend</h2>
            </div>
            <span id="onlineCount" class="mini-stat" aria-live="polite">0 online</span>
          </header>

          <!-- Scroll container + FAB -->
          <div class="messages-wrap">
            <div id="messages" class="messages" role="log" aria-live="polite" aria-label="Messages">
              <div class="messages-empty">Select a friend from the sidebar<br>to start chatting.</div>
            </div>
            <button class="scroll-btn" id="scrollBtn" aria-label="Scroll to latest messages">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>
              <span class="scroll-btn-badge hidden" id="scrollBadge"></span>
            </button>
          </div>

          <div id="typingIndicator" class="typing-indicator hidden" aria-live="polite" aria-atomic="true">
            <span id="typingText">Someone is typing</span>
            <span class="typing-dots" aria-hidden="true"><span></span><span></span><span></span></span>
          </div>

          <div class="message-form-wrap">
            <form id="messageForm" class="message-form">
              <input id="messageInput" type="text" placeholder="Type a message…" autocomplete="off" maxlength="1000"/>
              <button type="submit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                Send
              </button>
            </form>
            <div class="char-counter hidden" id="charCounter" aria-live="polite" aria-atomic="true">0 / 1000</div>
          </div>

        </section>
      </section>

      <div id="toast" class="toast hidden" role="alert" aria-live="assertive"></div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="app.js"></script>

    <script>
    /* ── Theme toggle ──────────────────────────────────── */
    (function () {
      var root  = document.documentElement;
      var btn   = document.getElementById('themeToggle');
      var STORE = 'novyn-theme';
      function applyTheme(t) {
        t === 'light' ? root.classList.add('light') : root.classList.remove('light');
        try { localStorage.setItem(STORE, t); } catch(e) {}
      }
      var saved = 'dark';
      try { saved = localStorage.getItem(STORE) || 'dark'; } catch(e) {}
      applyTheme(saved);
      btn && btn.addEventListener('click', function () {
        applyTheme(root.classList.contains('light') ? 'dark' : 'light');
      });
    })();

    /* ── Logout ────────────────────────────────────────── */
    (function () {
      var btn = document.getElementById('logoutBtn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        // Reload page — server session handled by socket reconnect
        window.location.reload();
      });
    })();

    /* ── Mobile panel switching ────────────────────────── */
    (function () {
      var BP      = 768;
      var sidebar = document.getElementById('mobileSidebar');
      var chat    = document.getElementById('mobileChat');
      var backBtn = document.getElementById('mobBackBtn');
      function isMobile() { return window.innerWidth <= BP; }
      function showPanel(panel) {
        if (!sidebar || !chat) return;
        if (panel === 'chat') {
          sidebar.setAttribute('data-mob-hidden', 'true');
          chat.removeAttribute('data-mob-hidden');
          if (backBtn) backBtn.setAttribute('data-visible', 'true');
        } else {
          chat.setAttribute('data-mob-hidden', 'true');
          sidebar.removeAttribute('data-mob-hidden');
          if (backBtn) backBtn.removeAttribute('data-visible');
        }
      }
      document.addEventListener('click', function (e) {
        if (!isMobile()) return;
        if (e.target.closest('.friend-btn')) showPanel('chat');
      });
      backBtn && backBtn.addEventListener('click', function () {
        if (isMobile()) showPanel('friends');
      });
      window.addEventListener('resize', function () {
        if (!isMobile()) {
          if (sidebar) sidebar.removeAttribute('data-mob-hidden');
          if (chat)    chat.removeAttribute('data-mob-hidden');
        }
      });
      new MutationObserver(function () {
        var layout = document.getElementById('chatLayout');
        if (layout && !layout.classList.contains('hidden') && isMobile()) showPanel('friends');
      }).observe(document.getElementById('chatLayout') || document.body, { attributes: true, attributeFilter: ['class'] });
    })();

    /* ── Scroll-to-bottom FAB ──────────────────────────── */
    (function () {
      var messagesEl = document.getElementById('messages');
      var scrollBtn  = document.getElementById('scrollBtn');
      var badge      = document.getElementById('scrollBadge');
      var unread     = 0;
      function atBottom() {
        if (!messagesEl) return true;
        return messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight <= 150;
      }
      function checkFAB() {
        if (!scrollBtn) return;
        scrollBtn.classList.toggle('visible', !atBottom());
        if (atBottom()) {
          unread = 0;
          if (badge) { badge.textContent = ''; badge.classList.add('hidden'); }
        }
      }
      messagesEl && messagesEl.addEventListener('scroll', checkFAB, { passive: true });
      scrollBtn && scrollBtn.addEventListener('click', function () {
        if (messagesEl) messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
        unread = 0;
        if (badge) { badge.textContent = ''; badge.classList.add('hidden'); }
        checkFAB();
      });
      window._novynFAB = {
        bump: function () {
          if (!atBottom()) {
            unread++;
            if (badge) { badge.textContent = unread > 9 ? '9+' : String(unread); badge.classList.remove('hidden'); }
          }
          checkFAB();
        },
        reset: function () {
          unread = 0;
          if (badge) { badge.textContent = ''; badge.classList.add('hidden'); }
          checkFAB();
        }
      };
    })();

    /* ── Character counter ─────────────────────────────── */
    (function () {
      var input   = document.getElementById('messageInput');
      var counter = document.getElementById('charCounter');
      var MAX = 1000, WARN = 800;
      if (!input || !counter) return;
      input.addEventListener('input', function () {
        var len = input.value.length;
        if (len === 0) { counter.classList.add('hidden'); return; }
        counter.classList.remove('hidden', 'warn', 'limit');
        counter.textContent = len + ' / ' + MAX;
        if (len >= MAX) counter.classList.add('limit');
        else if (len >= WARN) counter.classList.add('warn');
      });
    })();

    /* ── Emoji reactions ───────────────────────────────────
       Reactions are stored in a Map keyed by message-id so
       they survive re-renders when history reloads.
       ───────────────────────────────────────────────────── */
    (function () {
      var EMOJIS = ['👍','❤️','😂','😮','😢','🔥'];
      var messagesEl = document.getElementById('messages');
      if (!messagesEl) return;

      // Persistent reaction store: messageId → { emoji → { count, mine } }
      var reactionStore = {};

      function getStore(id) {
        if (!reactionStore[id]) reactionStore[id] = {};
        return reactionStore[id];
      }

      // Active picker tracking
      var activePickerMsgEl = null;

      function closePicker() {
        var open = document.querySelector('.reaction-picker');
        if (open) open.remove();
        activePickerMsgEl = null;
      }

      document.addEventListener('click', function (e) {
        if (!e.target.closest('.reaction-picker') && !e.target.closest('.msg-action-btn')) {
          closePicker();
        }
      });

      function renderReactions(msgEl, msgId) {
        var wrap = msgEl.querySelector('.message-reactions');
        if (!wrap) return;
        wrap.innerHTML = '';
        var store = getStore(msgId);
        Object.keys(store).forEach(function (emoji) {
          var entry = store[emoji];
          if (entry.count <= 0) return;
          var btn = document.createElement('button');
          btn.className = 'reaction-btn' + (entry.mine ? ' mine' : '');
          btn.dataset.emoji = emoji;
          btn.innerHTML = emoji + '<span class="r-count">' + entry.count + '</span>';
          btn.addEventListener('click', function () { toggleReaction(msgEl, msgId, emoji); });
          wrap.appendChild(btn);
        });
      }

      function toggleReaction(msgEl, msgId, emoji) {
        var store = getStore(msgId);
        if (!store[emoji]) store[emoji] = { count: 0, mine: false };
        if (store[emoji].mine) {
          store[emoji].count = Math.max(0, store[emoji].count - 1);
          store[emoji].mine  = false;
        } else {
          store[emoji].count++;
          store[emoji].mine = true;
        }
        renderReactions(msgEl, msgId);
      }

      function addReactionsUI(msgEl) {
        var msgId = msgEl.dataset.messageId || ('tmp-' + Date.now() + '-' + Math.random());
        if (!msgEl.dataset.messageId) msgEl.dataset.messageId = msgId;

        // Action button (emoji trigger) — positioned above bubble
        var actions = document.createElement('div');
        actions.className = 'msg-actions';

        var emojiBtn = document.createElement('button');
        emojiBtn.className   = 'msg-action-btn';
        emojiBtn.title       = 'React';
        emojiBtn.innerHTML   = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>';
        emojiBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          if (activePickerMsgEl === msgEl) { closePicker(); return; }
          closePicker();
          activePickerMsgEl = msgEl;

          var picker = document.createElement('div');
          picker.className = 'reaction-picker';
          EMOJIS.forEach(function (emoji) {
            var b = document.createElement('button');
            b.textContent = emoji;
            b.title = emoji;
            b.addEventListener('click', function (ev) {
              ev.stopPropagation();
              toggleReaction(msgEl, msgId, emoji);
              closePicker();
            });
            picker.appendChild(b);
          });
          // Append to body so overflow:hidden on card never clips it
          var rect = emojiBtn.getBoundingClientRect();
          picker.style.position = 'fixed';
          picker.style.bottom   = (window.innerHeight - rect.top + 6) + 'px';
          picker.style.left     = rect.left + 'px';
          picker.style.zIndex   = '9999';
          document.body.appendChild(picker);
        });

        actions.appendChild(emojiBtn);
        msgEl.appendChild(actions);

        // Reactions container
        var reactWrap = document.createElement('div');
        reactWrap.className = 'message-reactions';
        msgEl.appendChild(reactWrap);

        // Restore any stored reactions (after history re-render)
        renderReactions(msgEl, msgId);
      }

      // Watch for new message articles
      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (m) {
          m.addedNodes.forEach(function (node) {
            if (node.nodeType === 1 && node.tagName === 'ARTICLE' && node.classList.contains('message')) {
              addReactionsUI(node);
            }
          });
        });
      });
      observer.observe(messagesEl, { childList: true });

      // Expose so app.js can trigger reactions on incoming messages
      window._novynReactions = { store: reactionStore };
    })();
    </script>
  </body>
</html>